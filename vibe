#!/bin/bash

set -e

# Default modes
DEBUG=0
BUILD=0
DOWN=0
VSCODE=0
WEB=0

# Tool state directory
STATE_DIR="${HOME}/.local/state/vibe"
LAST_TOOL_FILE="${STATE_DIR}/last-tool"

# Read last-used tool (default to opencode)
TOOL=""
if [[ -f "$LAST_TOOL_FILE" ]]; then
  TOOL="$(cat "$LAST_TOOL_FILE")"
fi
TOOL="${TOOL:-opencode}"

# Parse flags
while getopts "BcdDlovw" opt; do
  case $opt in
    B) BUILD=1;;
    c) TOOL=claude;;
    d) DOWN=1;;
    D) DEBUG=1;;
    l) LOCAL=1;;
    o) TOOL=opencode;;
    v) VSCODE=1;;
    w) WEB=1;;
    *) echo "Usage: vibe [-B] [-c] [-d] [-D] [-l] [-o] [-v] [-w] [directory] [-- args...]"; exit 1;;
  esac
done
shift $((OPTIND - 1))

# Persist tool choice
mkdir -p "$STATE_DIR"
echo "$TOOL" > "$LAST_TOOL_FILE"

# Split positional args at -- separator
EXTRA_ARGS=()
if [[ "${1:-}" == "--" ]]; then
  # No directory arg, rest goes to tool
  shift
  EXTRA_ARGS=("$@")
  TARGET_DIR="$PWD"
else
  TARGET_DIR="$(realpath -- "${1:-$PWD}")"
  shift || true
  if [[ "${1:-}" == "--" ]]; then
    shift
  fi
  EXTRA_ARGS=("$@")
fi
export TARGET_DIR

# Base docker arguments
DIR_HASH="$(echo -n "$TARGET_DIR" | md5sum | cut -c1-4)"
PROJECT_NAME="vibe-$(basename "$TARGET_DIR")-$DIR_HASH"
export PROJECT_NAME="${PROJECT_NAME,,}"

DOCKER_COMPOSE="$(cat <<'EOF'
services:
  vibe:
    build:
      args:
        UID: ${UID:-1000}
        GID: ${GID:-1000}
        PROJECT_NAME: ${PROJECT_NAME}
        ENTRYPOINT: |
          #!/bin/bash

          # Export the SSH_AUTH_SOCK if it exists
          if [[ -S /tmp/ssh_auth_sock ]]; then
            export SSH_AUTH_SOCK=/tmp/ssh_auth_sock
          fi

          # Symlink the GnuPG socket to the correct directory if it exists
          if [[ -S /tmp/gnupg_sock ]]; then
            GNUPG_SOCK=$$(gpgconf --list-dir agent-socket)
            mkdir -m 700 -p "$$(dirname "$$GNUPG_SOCK")"
            ln -sf /tmp/gnupg_sock "$$GNUPG_SOCK"
          fi

          if [[ -f /tmp/host_gitconfig ]]; then
            ln -sf /tmp/host_gitconfig "$$HOME/.gitconfig"
          fi

          if [[ -f /tmp/host_claude_json ]]; then
            ln -sf /tmp/host_claude_json "$$HOME/.claude.json"
          else
            if [[ ! -f "$$HOME/.claude/claude.json" ]]; then
              echo '{}' > "$$HOME/.claude/claude.json"
            fi
            ln -sf "$$HOME/.claude/claude.json" "$$HOME/.claude.json"
          fi

          # Set EDITOR to the code wrapper if VS Code FIFO is available
          if [[ -p /tmp/vscode_fifo ]]; then
            export EDITOR="code -w"
          fi

          exec "$$@"
        CODE_WRAPPER: |
          #!/bin/bash

          # FIFO-based host signaling
          ARGS=()
          WAIT=0
          for arg in "$$@"; do
            if [[ "$$arg" == "-w" || "$$arg" == "--wait" ]]; then
              WAIT=1
              ARGS+=("$$arg")
            elif [[ "$$arg" == -* ]]; then
              ARGS+=("$$arg")
            else
              ARGS+=("$$(realpath "$$arg")")
            fi
          done
          echo "$${ARGS[*]}" > /tmp/vscode_fifo
          # Only wait for host response if -w/--wait was passed
          if [[ "$$WAIT" -eq 1 ]]; then
            read -r < /tmp/vscode_fifo_resp
          fi
        ON_BUILD: "${ON_BUILD:-}"
      dockerfile_inline: |
        FROM archlinux:latest

        # Install minimal dependencies
        RUN pacman -Syu --noconfirm \
          base-devel git sudo docker openssh nodejs npm

        # Create a non-root user and make it sudoer without password
        ENV USER=dev
        ARG UID=1000
        ARG GID=1000
        RUN groupadd -g $$GID $$USER \
          && useradd -mG wheel -g $$USER -s /bin/bash -u $$UID $$USER \
          && echo "$$USER ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/$$USER

        # Set the working directory
        ARG PROJECT_NAME
        RUN mkdir -p /$$PROJECT_NAME/workspace \
          && chown $$USER:$$USER /$$PROJECT_NAME/workspace
        WORKDIR /$$PROJECT_NAME/workspace

        # Create entrypoint script
        ARG ENTRYPOINT
        RUN echo "$$ENTRYPOINT" > /entrypoint.sh
        RUN chmod +x /entrypoint.sh

        ENTRYPOINT ["/entrypoint.sh"]

        # Switch to the non-root user
        USER $$USER

        # Premake some directories to avoid permission issues
        RUN mkdir -p \
          /home/$$USER/.local/bin \
          /home/$$USER/.local/share/opencode \
          /home/$$USER/.local/state/opencode \
          /home/$$USER/.local/state/claude \
          /home/$$USER/.config/opencode \
          /home/$$USER/.claude

        # Create a 'code' wrapper that signals the host to open VS Code
        ARG CODE_WRAPPER
        RUN echo "$$CODE_WRAPPER" > /home/$$USER/.local/bin/code
        RUN chmod +x /home/$$USER/.local/bin/code

        # Install opencode
        RUN curl -fsSL https://opencode.ai/install | bash

        # Install Claude Code
        RUN curl -fsSL https://claude.ai/install.sh | bash

        # Update the PATH
        ENV PATH="/home/$$USER/.opencode/bin:/home/$$USER/.local/bin:$$PATH"

        # Install yay (AUR helper) as the non-root user
        RUN git clone https://aur.archlinux.org/yay.git \
          && cd yay \
          && makepkg -si --noconfirm \
          && cd .. \
          && rm -rf yay

        # Run the ON_BUILD script if provided (used to pre-install tools)
        ARG ON_BUILD
        RUN if [ -n "$$ON_BUILD" ]; then \
          echo "$$ON_BUILD" | bash; \
        fi

        # Initial command to just keep the container running
        CMD ["bash", "-c", "sleep infinity"]
    ports:
      - 0:4096
    volumes:
      - ${TARGET_DIR}:/${PROJECT_NAME}/workspace
      - /var/run/docker.sock:/var/run/docker.sock
      - ${SSH_AUTH_SOCK:-/dev/null}:/tmp/ssh_auth_sock
      - ${GNUPG_SOCK:-/dev/null}:/tmp/gnupg_sock
      - ${GITCONFIG:-/dev/null}:/tmp/host_gitconfig
      - ${CLAUDE_JSON:-/dev/null}:/tmp/host_claude_json
      - ${OPENCODE_SHARE:-opencode_share}:/home/dev/.local/share/opencode
      - ${OPENCODE_STATE:-opencode_state}:/home/dev/.local/state/opencode
      - ${OPENCODE_CONFIG:-opencode_config}:/home/dev/.config/opencode
      - ${CLAUDE_HOME:-claude_home}:/home/dev/.claude
      - ${CLAUDE_STATE:-claude_state}:/home/dev/.local/state/claude
      - ${VSCODE_FIFO:-/dev/null}:/tmp/vscode_fifo
      - ${VSCODE_FIFO_RESP:-/dev/null}:/tmp/vscode_fifo_resp

volumes:
  opencode_share:
  opencode_state:
  opencode_config:
  claude_home:
  claude_state:
EOF
)"

# Utility function to run docker compose with the correct arguments
compose() {
  GID=$(id -g) docker compose --project-name "$PROJECT_NAME" "$@"
}

get_container_id() {
  docker ps --filter "name=${PROJECT_NAME}-vibe-1" -q
}

docker_exec() {
  # Use different detach keys to avoid conflicts with opencode's CTRL+P
  # Use -w to set CWD to the host path so tools key project data correctly
  docker exec -it --detach-keys='ctrl-e,e' "$(get_container_id)" "$@"
}

# Tear down the compose file and exit if requested
if ((DOWN)); then
  compose down
  # Clean up the VS Code FIFOs
  VSCODE_FIFO="/tmp/vibe-vscode-${PROJECT_NAME}.fifo"
  VSCODE_FIFO_RESP="/tmp/vibe-vscode-${PROJECT_NAME}-resp.fifo"
  rm -f "$VSCODE_FIFO" "$VSCODE_FIFO_RESP"
  exit 0
fi

# Setup the GPG extra socket.
# The extra socket is more restricted then the normal socket
GNUPG_SOCK=$(gpgconf --list-dir agent-extra-socket)
if [[ -S "$GNUPG_SOCK" ]]; then
  export GNUPG_SOCK
fi

# Setup gitconfig if it exists
if [[ -f "$HOME/.gitconfig" ]]; then
  export GITCONFIG="$HOME/.gitconfig"
fi

# Setup the VS Code FIFOs if 'code' is available on the host
HAS_CODE=0
if command -v code &>/dev/null; then
  HAS_CODE=1
  VSCODE_FIFO="/tmp/vibe-vscode-${PROJECT_NAME}.fifo"
  VSCODE_FIFO_RESP="/tmp/vibe-vscode-${PROJECT_NAME}-resp.fifo"
  for fifo in "$VSCODE_FIFO" "$VSCODE_FIFO_RESP"; do
    if [[ ! -p "$fifo" ]]; then
      mkfifo "$fifo"
      chmod 666 "$fifo"
    fi
  done
  export VSCODE_FIFO VSCODE_FIFO_RESP
fi

# Check if the user has an on_build.sh script in ~/.vibe
ON_BUILD_SCRIPT="${HOME}/.vibe/on_build.sh"
if [[ -f "$ON_BUILD_SCRIPT" ]]; then
  export ON_BUILD="$(cat "$ON_BUILD_SCRIPT")"
fi

# Setup host config directories (default) or use local Docker volumes (-l flag)
if ! ((LOCAL)); then
  if [[ "$TOOL" == "opencode" ]]; then
    export OPENCODE_SHARE="${HOME}/.local/share/opencode"
    export OPENCODE_STATE="${HOME}/.local/state/opencode"
    export OPENCODE_CONFIG="${HOME}/.config/opencode"

    mkdir -p "$OPENCODE_SHARE"
    mkdir -p "$OPENCODE_STATE"
    mkdir -p "$OPENCODE_CONFIG"
  else
    export CLAUDE_STATE="${HOME}/.local/state/claude"
    export CLAUDE_HOME="${HOME}/.claude"

    mkdir -p "$CLAUDE_STATE" "$CLAUDE_HOME"

    # Ensure the file exists with valid JSON so Docker can mount it as a file
    export CLAUDE_JSON="${HOME}/.claude.json"
    if [[ ! -f "$CLAUDE_JSON" ]]; then
      echo '{}' > "$CLAUDE_JSON"
    fi
  fi
fi

UP_ARGS=()
if ((BUILD)); then
  UP_ARGS+=("--build")
fi
compose --file - up "${UP_ARGS[@]}" -d <<< "$DOCKER_COMPOSE"

# Import the public GPG keys if the socket is available
if [[ -S "$GNUPG_SOCK" ]]; then
  gpg --export -a | docker exec -i "$(get_container_id)" gpg --import >/dev/null 2>&1
fi

# Helper to open VS Code attached to the container
open_vscode() {
  local container_id path hex_id
  container_id="$(get_container_id)"
  path="${1:-/$PROJECT_NAME/workspace}"
  hex_id="$(printf '%s' "$container_id" | od -A n -t x1 | tr -d ' \n')"
  code --folder-uri "vscode-remote://attached-container+${hex_id}${path}"
}

# Start background watcher and VS Code integration if 'code' is available
WATCHER_PID=""
if ((HAS_CODE)); then
  (
    while true; do
      if read -r args < "$VSCODE_FIFO"; then
        container_id="$(get_container_id)"
        hex_id="$(printf '%s' "$container_id" | od -A n -t x1 | tr -d ' \n')"
        uri_base="vscode-remote://attached-container+${hex_id}"

        # Separate flags from paths
        flags=()
        paths=()
        # shellcheck disable=SC2086
        for arg in $args; do
          if [[ "$arg" == -* ]]; then
            flags+=("$arg")
          else
            paths+=("$arg")
          fi
        done

        # Build code command with correct URI type for each path
        code_args=("${flags[@]}")
        has_folder=0
        for path in "${paths[@]}"; do
          if docker exec "$container_id" test -d "$path" 2>/dev/null; then
            has_folder=1
            code_args+=("--folder-uri" "${uri_base}${path}")
          else
            code_args+=("--file-uri" "${uri_base}${path}")
          fi
        done

        # Always attach to /workspace unless a directory was explicitly given
        if [[ "$has_folder" -eq 0 ]]; then
          code_args+=("--folder-uri" "${uri_base}/$PROJECT_NAME/workspace")
        fi

        code "${code_args[@]}"
        # Only signal response if -w/--wait was requested
        if [[ " ${flags[*]} " == *" -w "* || " ${flags[*]} " == *" --wait "* ]]; then
          echo "done" > "$VSCODE_FIFO_RESP"
        fi
      fi
    done
  ) &
  WATCHER_PID=$!
fi

# Clean up watcher on exit
cleanup() {
  if [[ -n "$WATCHER_PID" ]]; then
    kill "$WATCHER_PID" 2>/dev/null || true
  fi
}
trap cleanup EXIT

# Open VS Code if requested via -v flag
if ((VSCODE)); then
  if ! ((HAS_CODE)); then
    echo "Error: 'code' command not found on host" >&2
    exit 1
  fi
  open_vscode /$PROJECT_NAME/workspace
fi

# Shell into the container if in debug mode
if ((DEBUG)); then
  docker_exec /entrypoint.sh bash
  exit 0
fi

# Web UI mode
if ((WEB)); then
  case "$TOOL" in
    opencode)
      PORT=$(docker port "$(get_container_id)" 4096 | head -1 | cut -d: -f2)
      docker_exec /entrypoint.sh "$TOOL" web --port 4096 --hostname 0.0.0.0 "${EXTRA_ARGS[@]}" 2>&1 \
        | sed -u "s|localhost:4096|localhost:$PORT|g"
      ;;
    claude)
      docker_exec /entrypoint.sh "$TOOL" --dangerously-skip-permissions --remote "${EXTRA_ARGS[@]}"
      ;;
  esac
  exit 0
fi

# Run the selected tool in the container
TOOL_FLAGS=()
if [[ "$TOOL" == "claude" ]]; then
  TOOL_FLAGS+=(--dangerously-skip-permissions)
fi

echo "Running '$TOOL' in container..."
if [[ ${#EXTRA_ARGS[@]} -gt 0 ]]; then
  docker_exec /entrypoint.sh "$TOOL" "${TOOL_FLAGS[@]}" "${EXTRA_ARGS[@]}"
elif [[ "$TOOL" == "claude" ]]; then
  CLAUDE_PROJECT_DIR="/home/dev/.claude/projects/-${PROJECT_NAME}-workspace"
  : "$(
    docker_exec bash -c 'ls -t '"${CLAUDE_PROJECT_DIR}"'/*.jsonl' 2>/dev/null \
    | head -1 | xargs -r basename
  )"
  SESSION_ID="${_%.*}" # Strip .jsonl suffix

  if [[ -n "$SESSION_ID" ]]; then
    echo "Resuming session $SESSION_ID"
    docker_exec /entrypoint.sh "$TOOL" --resume "$SESSION_ID" "${TOOL_FLAGS[@]}"
  else
    docker_exec /entrypoint.sh "$TOOL" "${TOOL_FLAGS[@]}"
  fi
else
  docker_exec /entrypoint.sh "$TOOL" "${TOOL_FLAGS[@]}" --continue
fi
